From 16c08b00c053232804ac767979e523c1ed807c9a Mon Sep 17 00:00:00 2001
From: Jeongseok Lee <jeongseok@meta.com>
Date: Sat, 20 Sep 2025 06:10:10 -0700
Subject: [PATCH 5/5] Import Optional in __init__.py for Python 3.14
 compatibility

---
 drjit/__init__.py | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/drjit/__init__.py b/drjit/__init__.py
index 8bb6dc1e..fb2fcc51 100644
--- a/drjit/__init__.py
+++ b/drjit/__init__.py
@@ -1,5 +1,17 @@
 from . import detail
 
+from typing import Optional  # used in signatures (e.g., rtol: Optional[float])
+import typing as _typing
+try:
+    # Some rewritten/wrapped functions may have a non-module globals() during
+    # annotation evaluation. As a safety-net, make Optional visible via builtins.
+    import builtins as _builtins
+    if not hasattr(_builtins, "Optional"):
+        _builtins.Optional = _typing.Optional
+except Exception:
+    # Best-effort only; if this fails nothing gets worse.
+    pass
+
 with detail.scoped_rtld_deepbind():
     try:
         from . import _drjit_ext as _drjit_ext
-- 
2.51.0

