From 60eb972424864e3aaaa8d0b0ab2da7da73e96e09 Mon Sep 17 00:00:00 2001
From: Jeongseok Lee <jeongseok@meta.com>
Date: Sat, 30 Aug 2025 16:44:47 -0700
Subject: [PATCH 1/4] Use system libraries

---
 CMakeLists.txt           |  5 ++++-
 src/extra/CMakeLists.txt | 18 +++++++++++++-----
 2 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index ce5c00db..90177568 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -29,6 +29,9 @@ option(DRJIT_ENABLE_LEAK_WARNINGS "Emit DrJit and nanobind leak warnings? By def
 option(DRJIT_STABLE_ABI       "Build Python extension using the CPython stable ABI? (Only relevant when using scikit-build)" OFF)
 mark_as_advanced(DRJIT_STABLE_ABI)
 
+option(DRJIT_USE_SYSTEM_NANOBIND "Use system-installed nanobind" OFF)
+option(DRJIT_USE_SYSTEM_ROBIN_MAP "Use system-installed robin-map" OFF)
+
 # ----------------------------------------------------------
 #  Check if submodules have been checked out, or fail early
 # ----------------------------------------------------------
@@ -198,6 +201,7 @@ endif()
 
 if (DRJIT_MASTER_PROJECT)
   install(DIRECTORY include/drjit DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
+  install(DIRECTORY ext/drjit-core/include/drjit-core DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
 
   install(TARGETS drjit-core EXPORT drjitTargets DESTINATION drjit)
   install(TARGETS drjit-extra EXPORT drjitTargets DESTINATION drjit)
@@ -256,7 +260,6 @@ if (DRJIT_MASTER_PROJECT)
   endif()
 
   if (DRJIT_ENABLE_JIT)
-    install(DIRECTORY ext/drjit-core/include/drjit-core DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
     install(DIRECTORY ext/drjit-core/ext/nanothread/include/nanothread DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})
   endif()
 
diff --git a/src/extra/CMakeLists.txt b/src/extra/CMakeLists.txt
index 455f4c74..d5a5de98 100644
--- a/src/extra/CMakeLists.txt
+++ b/src/extra/CMakeLists.txt
@@ -24,10 +24,19 @@ endif()
 target_compile_definitions(drjit-extra PRIVATE -DDRJIT_EXTRA_BUILD)
 target_link_libraries(drjit-extra PRIVATE drjit drjit-core nanothread)
 
-target_include_directories(drjit-extra PRIVATE
-  ../../ext/drjit-core/ext/robin_map/include
-  ../../ext/nanobind/include
-)
+if (DRJIT_USE_SYSTEM_NANOBIND)
+  find_package(nanobind REQUIRED CONFIG)
+  target_link_libraries(drjit-extra PRIVATE nanobind)
+else()
+  target_include_directories(drjit-extra PRIVATE ../../ext/nanobind/include)
+endif()
+
+if (DRJIT_USE_SYSTEM_ROBIN_MAP)
+  find_package(tsl-robin-map REQUIRED CONFIG)
+  target_link_libraries(drjit-extra PRIVATE tsl::robin_map)
+else()
+  target_include_directories(drjit-extra PRIVATE ../../ext/drjit-core/ext/robin_map/include)
+endif()
 
 if (DRJIT_ENABLE_LLVM)
   target_compile_definitions(drjit-extra PRIVATE -DDRJIT_ENABLE_LLVM)
@@ -36,4 +45,3 @@ endif()
 if (DRJIT_ENABLE_CUDA)
   target_compile_definitions(drjit-extra PRIVATE -DDRJIT_ENABLE_CUDA)
 endif()
-
-- 
2.44.0.windows.1

